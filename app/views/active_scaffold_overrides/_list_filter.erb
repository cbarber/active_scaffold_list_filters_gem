<% url_options = params_for(:action => :index, :escape => false).delete_if{|k,v| k == 'list_filter'}

  options = {:id => element_form_id(:action => 'list_filter'),
             :class => "as_form list_filter",
             :remote => true,
             :method => :get,
             'data-as_load' => 'form',
             'data-as_action' => 'list_filter',
             'data-loading' => 'true'
           }
-%>


<%= form_tag url_options, options %>
  <%= hidden_field_tag('list_filter[input]','filter') %>
  
  <div class="filter_accordion">
      <% filter_config.filters.each do |filter| %>
        <div class="filter_handle" title="<%=as_(filter.tab_label)%>">
          <%=as_(filter.tab_label)%>
          <canvas width=250 height=0></canvas><!--[if IE]><div class="filter_trigger"></div><![endif]--></div>
      <% end %>

      <div class="floatClear"></div>
      
      <% 
      id = params[:eid] || params[:controller]
      session_index = "as:#{id}"
      filter_session_base = session[session_index]["list_filter"] unless session[session_index]["list_filter"].nil?   
      filter_config.filters.each do |filter|
          filter_session = filter_session_base[filter.filter_type] unless filter_session_base.nil?
          filter_session = filter_session[filter.name.to_s] unless filter_session.nil?
          filter.session = filter_session
      %>
        <div class="lite_box">
          <div class="filter_body">
          <div class="t">
            <div class="tl_nocurve"></div>
              <div class="tr"></div>
            </div>
            <div class="m">
              <h3><%=as_(filter.label)%></h3>
              <%= render :partial => filter.filter_type, :locals => { :filter => filter, :filter_session => filter_session } -%>
                    
              <div class="floatClear"></div>
            </div>
              <div class="b">
                <div class="bl"></div>
              <div class="br"></div>
            </div>
          </div>
        </div>

      <% end %> 
  </div>

  <div class="floatClear"></div>

  <div style='float:right;'>
    <%= loading_indicator_tag(:action => :list_filter) %>
    <%= submit_tag "Filter", :class => "main_button slim_left_margin", :id => "filter_submit_button" -%>
    <%= link_to as_(:reset), request.path, :class => "as_cancel" %>
  </div>
</form>

<script type="text/javascript">
  init_filter_accordions();

  (function() {
    var form_css_id = '<%= options[:id] -%>';

    /* allow users to press enter in text inputs to submit form*/
    var inputs = $(form_css_id).elements;
    var submit_button = $('filter_submit_button');

    var enterToSubmitForm = function(event) {
      if (event.keyCode == Event.KEY_RETURN  || event.which == Event.KEY_RETURN ) {
        submitForm(event);
      }
    }

    var submitForm = function(event) {
      submit_button.click();
      Event.stop(event);
    }

    for (var index = 0; index < inputs.length; ++index) {
      /* input fields */
      if(inputs[index].type == "text") {
        inputs[index].observe('keypress', enterToSubmitForm);
      }else {
        inputs[index].observe('change', submitForm);
      }
    }

    // calendar date select hack so that form is auto submitted on change by defining onsubmit() (previously undefined) to map to form submission
    $(form_css_id).onsubmit = function() { submit_button.click() }

  })();
</script>
